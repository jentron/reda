---
title: "Introduction to reda by Examples"
author: Wenjie Wang
date: "`r Sys.Date()`"
bibliography:
- ../inst/bib/reda-intro.bib
vignette: >
  %\VignetteIndexEntry{Introduction to reda by Examples}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
output: rmarkdown::html_vignette
---

The package **reda** mainly provides function to fit gamma frailty model with
either a piecewise constant or a spline as the baseline rate function
for recurrent event data. What's more, some handy functions are designed,
such as computing and plotting sample nonparametric mean cumulative function,
or so-called Nelson-Aalen estimator.

In this vignette, we mainly introduce the basic usage of the functions
in the package **reda** by some examples.

## Simulated Sample Recurrent Event Data

```{r setup}
library(reda) # attach package 
data(simuDat) # attach sample dataset
```

First of all, the sample recurrent event data 
we are going to use in the following examples is called **simuDat**
and it contains totally `r ncol(simuDat)` observations of `r nrow(simuDat)`.

```{r data}
str(simuDat)
```

where

* ID: Subjects indification.
* time: Event or censoring time.
* event: Event indicator, 1 = event; 0 = censored.
* group: Treatment group indicator.
* x1: Continuous variable. 

The dataset is originally simulated by thinning method [@lewis1979]
and further processed for a better demonstration purpose.

## Data Checking and Model Fitting

In the main function **rateReg** for model fitting,
formula response is specified by function **Survr**,
which has embeded data checking procedure for recurrent event data modeled
by method based on counts and rate function. Therefore, before model fitting,
the observations of the covariates specified in the formula will be checked.
The checking rules include

* Identificator of each subject cannot be missing.
* Event indicator must be coded as 0 (censored) or 1 (event).
* Event time and censoring time cannot be missing.
* Each subject must have one and only one censoring time.
* Event time cannot not be later than censoring time.

The subject's ID will be pinpointed if its observation violates any checking
rule shown above. 

### Model with Constant Rate Function

The default model when argument **df**, **knots**, and **degree** are not
specified is gamma frailty model with (one piece) constant rate function,
which is equivalent to negative binomial regression of the same
shape and rate parameter in gamma prior.

In the following examples, we fit the models on the first 50 subjects
by specifying argument **subset**. 

```{r const}
constFit <- rateReg(Survr(ID, time, event) ~ group + x1, data = simuDat,
                    subset = ID %in% 1:50)
# brief summary
constFit # or explicitly call show(constFit)
```

The function **rateReg** returns **rateReg-class** object, which can be simply
printed out by calling the object.
(Internally, **show** method for **rateReg** object is called.)

### Model with Piecewise Constant Rate Function

When argument **df** or **knots** (at least one internal knot) is specified,
the model becomes gamma frailty model with piecewise constant rate funtion
if argument degree is specified to be zero as default.

We may simply specify **df** and leave **knots** and **degree** as default.
Then piecewise constant rate function will be applied and the number of pieces
will equal **df**. The internal **knots** will be automatically specified
at suitable quantiles of the covariate representing event and censoring time.

For example, two pieces' constant rate function can be simply specified
by setting **df**=2. The internal knot will be the median time of all the
event and censoring time.

```{r twoPieces}
# two pieces' constant rate function i.e. one internal knot
twoPiecesFit <- rateReg(Survr(ID, time, event) ~ group + x1, df = 2, 
                        data = simuDat, subset = ID %in% 1:50)
twoPiecesFit
```

In the example shown above, the internal knots is specified automatically
to be `r twoPiecesFit@knots` and the rate function is two pieces' constant.

If internal **knots** are specified explicitly, the **df** will be neglected
even if it is specified. An example of model with six pieces' constant rate
function is given as follows:

```{r sixPieces}
piecesFit <- rateReg(Survr(ID, time, event) ~ group + x1, df = 2,
                     knots = seq(from = 28, to = 140, by = 28),
                     data = simuDat, subset = ID %in% 1:50)
piecesFit # note that df = 2 is neglected since knots are specified
```



## Estimates 

```{r estimates, eval = FALSE}
# point estimates of coefficients
coef(heartFit)
# confidence interval for coefficients
confint(heartFit)
# estimates of piece-wise constant baseline rate function
baseline(heartFit)
```

## Summary of the Model Fits

```{r summary, eval = FALSE}
# a brief summary for the model fits
heartFit 
# summary in more details
summary(heartFit)
```

# Mean Cumulative Function (MCF)

## Empirical MCF

```{r empirMcf, eval = FALSE}
mcf(Survr(ID, time, event) ~ group, data = simuDat,
    subset = ID %in% 100:101, na.action = na.omit, level = 0.9)
sampleMCF <- mcf(Survr(ID, time, event) ~ group, data = simuDat)
```

```{r plotempir, fig.height=6, fig.width=7, eval = FALSE}
plotMcf(sampleMCF, conf.int = TRUE, mark.time = TRUE, 
        lty = c(1, 3), col = c("orange", "navy"))
```

## Estimated MCF from the HEART Model

Note that function 'plotMcf' returns 'ggplot' object so that the plot can be 
further customized properly.

### Baseline MCF 

```{r baselineMCF, fig.height=6, fig.width=7, eval = FALSE}
baselineMcf <- mcf(heartFit)
plotMcf(baselineMcf, conf.int = TRUE, col = "royalblue") +
    ggplot2::theme_bw()
```

### MCF for certain group(s)

```{r heartMcf, fig.height=6, fig.width=7, eval = FALSE}
estmcf <- mcf(heartFit, 
              newdata = data.frame(
                  x1 = c(0.1, 0.1), 
                  group = gl(2, 1, labels = c("Treat", "Contr"))), 
              groupName = "Group", 
              groupLevels = c("Treatment", "Control"))
plotMcf(estmcf, conf.int = TRUE, col = c("royalblue", "red")) +
    ggplot2::theme_bw()
```

## Reference
